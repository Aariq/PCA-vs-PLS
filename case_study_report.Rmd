---
title: "Case Study Dataset Review"
output: 
  html_notebook: 
    code_folding: hide
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
---

```{r include=FALSE}
library(tidyverse)
library(lubridate)
library(glue)
library(here)
library(ropls)
library(holodeck)
```


This is a brief review of the possible datasets I could use with results from PCA and PLS.

# Mourning Cloaks

```{r}
mocl <- read_rds(here::here("data", "mourning-cloaks", "mocl-seasonal.rds"))
```

## Data Source
Butterfly survey data is combined with weather data for MA from NOAA.

## Data Description
Includes data from 1991 to 2010.  Mourning cloak abundance and fall morning cloak abundance are possible Y variables.  Cumulative cooling degree days, cumulative heating degree days, mean precip, PDSI, min temp, mean temp, and max temp for every month are the X variables.  Using the monthly data gives similar results as using seasonaly aggregated data including the previous fall.

## Original analysis
N/A---this is not a published dataset

## PCA

```{r message=FALSE, warning=FALSE}
pca <- opls(select(mocl, -MOCL, -MOCL_fall, -year), plotL = FALSE)
```

**Loadings:**

```{r}
get_loadings(pca) %>%
  arrange(desc(abs(p1)))
```

**Plot shows no relationship between PCs and MOCL_fall**

```{r}
get_scores(pca) %>% 
  ggplot(aes(x = p1, y = p2, color = mocl$MOCL)) +
  geom_point() +
  scale_color_viridis_c() +
  theme_dark()
```

## PCA-regression


## PLSR

PLS model is non-significant

```{r}
plsr <- try(opls(select(mocl, -MOCL, -MOCL_fall, -year), mocl$MOCL_fall))
```

If I force one predictive component, the $Q^2$ value is negative.  I would conclude the model is not significant.

**OPLS plot:**

```{r message=FALSE, warning=FALSE}
plsr <- opls(select(mocl, -MOCL, -MOCL_fall, -year), mocl$MOCL_fall, predI = 1, orthoI = 1, plotL = FALSE, printL = FALSE)
plot_opls(plsr) + theme_dark()
```

**OPLS loadings:**

The loadings show Summer is more important for Fall mourning cloak abundance while PCA pulls out Spring as most variation in the data.

```{r}
get_loadings(plsr) %>% 
  arrange(desc(abs(p1)))
```

# Tomatoes

```{r}
tomato <- read_rds(here::here("data", "literature", "Muir et al.", "tomatoes.rds"))
tomato.filtered <- tomato %>% 
  filter(precip < 2000)
```

## Data source

From a [paper](https://nph.onlinelibrary.wiley.com/doi/epdf/10.1111/nph.14285) in New Phytologist by Muir et al. 

## Data description

9 leaf traits measured on 16 species of *Solanum* with 3-5 individuals per species. For each species, they include a lattitude and longitude, which I used to pull temperature and precipitation data from WorldClim, like they describe in the paper.

## Original Analysis

They measure leaf traits in several *Solanum* species, do PCA to re-capitulate the leaf economics spectrum (LES), and then use that PC in a phylogenetic regression (to see how LES varied within and among species), and in a regression with the mean precip and temp of species habitats (to see if LES varies by habitat type).  Instead, we could ask "what leaf traits vary by temperature or precipitation?"

They show that the correlation between PC1 and precipitation is only significant if a species that grows in very wet habitats (*S. juglandifolium*) is included.  With that species included, PC1 is a significant predictor of precipitation but not temperature.  Without it, PC1 is a significant predictor of temperature, but not precipitation.

I played around with this species a bit, and either way the PLSR **is significant for both temp and precip**.

## PCA

I'm going to use the data without *S. juglandifolium* for now and focus on precipitation.

```{r}
# tom.pca <- opls(tomato %>% dplyr::select(lma.leaflet:Rdark), plotL = FALSE)
tom.pca <- opls(tomato.filtered %>% dplyr::select(lma.leaflet:Rdark), plotL = FALSE)
```

**Loadings:**

```{r}
get_loadings(tom.pca) %>% 
  arrange(desc(abs(p1)))
```

These are the same axes as in the original publication, but PC1 is reversed in sign.

**Score plot**

```{r}
tom.pca.data <- get_plotdata(tom.pca)
ggplot(tom.pca.data$scores, aes(x = p1, y = p2)) +
  geom_point(aes(color = tomato.filtered$precip)) +
  scale_color_viridis_c() +
  labs(x = glue("P1 ({tom.pca.data$var_explained[1,1] * 100}%)"),
       y = glue("P2 ({tom.pca.data$var_explained[2,1] * 100}%)")) +
  theme_dark()
```


## PCA-regression on precipitation

```{r}
tomato.1 <- tomato.filtered %>% add_column(pc1 = tom.pca.data$scores$p1)
m1 <- lm(precip ~ pc1, data = tomato.1)
lmtest::lrtest(m1)
summary(m1)
```

PC1 doesn't explain variation in precipitation without *S. juglandifolium* included.

## PLSR on precipitation

PLS regression produces only a single component model, but thecross-validation and permutation testing is good!

```{r}
tom.plsr <- 
  opls(tomato.filtered %>% dplyr::select(lma.leaflet:Rdark), tomato.filtered$precip,
       plotL = FALSE, permI = 200)
# single component model
```

**OPLS plot:**

For the sake of visualization, I'll plot an OPLS score plot

```{r}
#plot OPLS for the sake of visualization
tom.oplsr <- 
  opls(tomato.filtered %>% dplyr::select(lma.leaflet:Rdark), tomato.filtered$precip, 
       plotL = FALSE, permI = 200, predI = 1, orthoI = NA)

plot_opls(tom.oplsr) + theme_dark()
```

**PLSR Loadings:**

```{r}
get_loadings(tom.plsr) %>%
  arrange(desc(abs(p1)))
```

Leaf mass per area (LMA) and leaf dry matter content (LDMC) seem to be positively related to precipitation. This indicates that thinner leaves are associated with drier habitats. That seems counter-intuitive, but the authors also thought their results were counter-intuitive.
