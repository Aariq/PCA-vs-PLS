---
title: "Cupcake Analysis"
author: Eric R. Scott
output: html_notebook
---
```{r}
library(tidyverse)
library(ropls)
library(MVN)
library(chemhelper)
library(latex2exp)
library(here)
library(cowplot)
```

# Load Data
```{r}
recipes_wide <- read_rds("/Users/scottericr/Documents/Tufts/cupcakes-vs-muffins/recipes_wide.rds")
```

# Check multivariate normality
```{r}
mvn(select_if(recipes_wide, is.double), scale = TRUE, multivariatePlot = "qq")
mvn(select_if(recipes_wide, is.double), scale = TRUE, transform = "sqrt", multivariatePlot = "qq")
```
No, not multivariate normal and transformations do nothing because of all the zeroes probably.  

# Do preliminary PCA
```{r}
recipe_pca <- opls(select_if(recipes_wide, is.double), scaleC = "standard", plotL = FALSE)
plot(recipe_pca,
     parAsColFcVn = recipes_wide$Type,
     parLabVc = recipes_wide$`Recipe ID`,
     parCompVi = c(1, 2))
```

# PLS-DA
Try with unscaled data.  Elizabeth predicts taht in pls-da scaling is less important than in PCA.
In this case, at least, scaling reduces R2X (from 0.75 to 0.098), increases R2Y (from 0.41 to 0.62), has only a slight effect on Q2 (from 0.39 to 0.47), and doesn't effect p-values.  It also changes VIP scores substantially.
```{r}
recipe_plsda <- opls(select_if(recipes_wide, is.double), recipes_wide$Type,
                     scaleC = "none",
                     plotL = FALSE,
                     permI = 200,
                     predI = 2)

plot(recipe_plsda)
get_VIP(recipe_plsda) %>% arrange(desc(VIP))
getLoadingMN(recipe_plsda) %>% as.data.frame()
```

# Try with reduced dataset
The sample size is unrealistic for an ecological experiment.  Try taking a subsample of muffins and cupcakes (n = 20?)

```{r}
# set.seed(8)
# set.seed(100)
set.seed(25)
recipes_small <- recipes_wide %>% group_by(Type) %>% sample_n(20) %>% ungroup()
#get rid of empty columns
recipes_small <- recipes_small %>% select_if(~is.character(.) | (is.double(.) & var(.) != 0))
#get rid of rare ingredients

keepers <- recipes_small %>%
  mutate_if(is.double, ~.!=0) %>%
  summarise_if(is.logical, sum) %>% 
  gather() %>%
  filter(value > 2) %>% 
  .$key %>% c("Type", "Recipe ID", .)

recipes_small <- recipes_small %>% select_at(vars(keepers))
```

## Check multivariate normality
```{r}
mvn(select_if(recipes_small, is.double), scale = TRUE, multivariatePlot = "qq")
mvn(select_if(recipes_small, is.double), scale = TRUE, transform = "sqrt", multivariatePlot = "qq")
```
seems to pass?

```{r}
pca_small <- opls(select_if(recipes_small, is.double))
#pls-da gives a single component model, so do opls-da for the sake of getting a plot.
oplsda_small <- opls(select_if(recipes_small, is.double), recipes_small$Type,
                     permI = 200,
                     predI = 1,
                     orthoI = NA)
```
```{r}
pca_plotdata <- get_plotdata(pca_small)
oplsda_plotdata <- get_plotdata(oplsda_small)
```
```{r}
pca.plot <- ggplot(pca_plotdata$plot_data, aes(x = p1, y = p2 * -1, color = recipes_small$Type)) +
  geom_point() +
  stat_ellipse() +
  labs(x = paste0("PC1 (", pca_plotdata$var_explained$R2X[1] * 100,"%)"),
       y = paste0("PC2 (", pca_plotdata$var_explained$R2X[2] * 100, "%)")) +
  scale_color_discrete("Recipe Type", labels = c("Cupcake", "Muffin")) +
  theme_bw()
```
```{r}
opls.plot <- ggplot(oplsda_plotdata$plot_data, aes(x = p1, y = o1, color = y1)) +
  geom_point() +
  stat_ellipse() +
  labs(x = paste0("Predictive Axis (", oplsda_plotdata$axis_stats$R2X[1] * 100,"%)"),
       y = paste0("Orthogonal Axis (", oplsda_plotdata$axis_stats$R2X[2] * 100, "%)")) +
  scale_color_discrete("Recipe Type", labels = c("Cupcake", "Muffin")) +
  theme_bw() +
  ggtitle(label = NULL,
          subtitle = TeX(paste0(
            "$R^{2}_Y = ", oplsda_plotdata$model_stats$`R2Y(cum)`, "$; ",
            "$Q^2 = ", oplsda_plotdata$model_stats$`Q2(cum)`, "$; ",
            "$p_{Q^2} = ", oplsda_plotdata$model_stats$pQ2, "$")))
```
```{r}
cupcake_plot <- plot_grid(pca.plot + theme(legend.position = "none") + ggtitle("", ""),
          opls.plot + theme(legend.position = "none"),
          get_legend(opls.plot),
          ncol = 3,
          rel_widths = c(1, 1, 0.35),
          labels = c("A", "B", ""))
cupcake_plot
save_plot(here("figs", "cupcakeplot.png"), cupcake_plot, ncol = 2, base_height = 3)
```

```{r}
VIPs <- get_VIP(oplsda_small) %>%
  arrange(desc(VIP))

opls_loadings <- getLoadingMN(oplsda_small) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Variable") %>% 
  arrange(desc(p1))

pca_loadings <- getLoadingMN(pca_small) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Variable") %>% 
  arrange(desc(p2))

variation <- recipes_small %>% 
  select_if(is.double) %>%
  summarise_all(sd) %>%
  gather(key = "Variable", value = "Standard Deviation")

table2 <- left_join(VIPs, opls_loadings) %>%
  rename("OPLS-DA Predictive Axis Loading" = p1) %>%
  left_join(pca_loadings %>%
              dplyr::select(Variable, p1, p2)) %>%
  rename("PC1 Loading" = p1, "PC2 Loading" = p2) %>%
  left_join(variation)
```


Need to scale PC loadings to match axis of OPLS-DA? Is standard deviation helpful at all?
```{r}
table2 %>%
  select(-`Standard Deviation`) %>%
  select_if(is.double) %>% 
  map2_df(.y = c(2,3,3,3), .f = ~round(.x, .y)) %>%
  add_column(Variable = table2$Variable) %>%
  select(Variable, everything()) %>% 
  write_csv(here("figs", "table2.csv"))
```


# Results
PCA and OPLS-DA both show some separation between cupcakes and muffins, but there are substantial differences in the two methods. First, although PC1 explains the greatest amount of covariation in the ingredients, it does not show any separation between cupcakes and muffins.  PC2 shows some weak separation between cupcakes and muffins.  This indicates that the variables with the greatest (co)variation in the dataset are not good predictors of the type of baked good.  Even when comparing PC2, which separates cupcakes and muffins, with the OPLS-DA predictive axis, there are substantial differences. For example, "unitless" ingredients (e.g. "one sweet potato", "25 blueberries") are strongly negatively correlated with PC2 (toward muffins), however, it is not a good predictor of muffins vs. cupcakes as evidenced by its low VIP score and its weak correlation with the OPLS-DA predictive axis. Conversely, "spice" is a good predictor of muffins vs. cupcakes (muffins have more spices than cupcakes) as evidenced by a VIP greater than 1 and a stronger correlation with the OPLS-DA predictive axis, but have a weak correlation with PC2.


