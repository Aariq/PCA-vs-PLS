---
title: "Re-analysis of Muir et al. data"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(ropls)
library(chemhelper)
library(glue)
library(colorspace)
```

# Read in Data

```{r}
tomato <- read_rds(here("data", "literature", "Muir et al.", "tomatoes.rds"))

#remove S.juglandifolium
tomato.filtered <-
  tomato %>% 
  filter(Spe != "jug")
```
```{r}
tomato %>% group_by(Spe) %>% count()
```


# Fit PCA with S. juglandifolium

```{r}
tom.pca <- opls(tomato %>% dplyr::select(lma.leaflet:Rdark), plotL = FALSE)
tom.pca.data <- get_plotdata(tom.pca)
ggplot(tom.pca.data$scores, aes(x = p1, y = p2)) +
  geom_point(aes(fill = tomato$precip), shape = 21, size = 2) +
  scale_color_continuous_sequential("Blue-Yellow", aesthetics = "fill",
                                    name = "Precipitation") +
  labs(x = glue("P1 ({tom.pca.data$axis_stats[1,1] * 100}%)"),
       y = glue("P2 ({tom.pca.data$axis_stats[2,1] * 100}%)")) +
  theme_bw()
```
```{r}
get_loadings(tom.pca) %>% 
  arrange(desc(abs(p2)))
```

# PCA without S. juglandifolium
```{r}
tom.pca2 <- opls(tomato.filtered %>% dplyr::select(lma.leaflet:Rdark), plotL = FALSE)
tom.pca2.data <- get_plotdata(tom.pca2)
ggplot(tom.pca2.data$scores, aes(x = p1, y = p2)) +
  geom_point(aes(fill = tomato.filtered$precip), shape = 21, size = 2) +
  scale_color_continuous_sequential("Blue-Yellow", aesthetics = "fill",
                                    name = "Precipitation") +
  labs(x = glue("P1 ({tom.pca2.data$axis_stats[1,1] * 100}%)"),
       y = glue("P2 ({tom.pca2.data$axis_stats[2,1] * 100}%)")) +
  theme_bw()
```

# PCR

# Fit PLSR

```{r}
tom.plsr <- 
  opls(tomato %>% dplyr::select(lma.leaflet:Rdark), tomato$precip)
# single component model
```
```{r}
#plot OPLS for the sake of visualization
tom.plsr <- 
  opls(tomato %>% dplyr::select(lma.leaflet:Rdark), tomato$precip, 
       plotL = FALSE, permI = 500, predI = 1, orthoI = NA)

plot_opls(tom.plsr)
```
```{r}
get_loadings(tom.plsr) %>% arrange(desc(abs(p1)))
```


YUSSS!!