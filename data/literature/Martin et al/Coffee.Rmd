---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(ropls)
library(chemhelper)
```

This is worth revisiting!  The PCA and PLS both show similar patterns (separation by site).  However, PLS separates along two axes (one site vs. all others on axis one, the other three sites on axis three) and finds some pretty different VIPs (also check out loadings of p2).  Should check and see what the paper did originally.



```{r}
coffee <- read_tsv(here("data", "literature", "Martin et al", "Martin et al. Functional Ecology.txt"))
```

```{r}
coffee
```

# Multivariate analysis of plant traits

The authors of the paper focused on classic leaf economic spectrum (LES) plant traits, although the dataset also includes growth measurements, soil nutrients, and other environmental properties.

"Our PCA included Amass, LMA, leaf C, leaf N, leaf area and leaf tissue density; Amax was not included in the PCA as due to its close correlation with Amass (r2 = 0·84, P < 0·001). We calculated PCA axis 1 and 2 scores for each leaf and included these in analyses on the causes of intraspecific trait variation (see below)."

According to their figure, it also included $g_s$ and water use efficiency

## Recapitulate their PCA

```{r}
# subset LES traits
LES <- coffee %>% select(amass, lma_g_m2, leafc, leafn, area_cm2, leaf_density_g_cm3, cond, wue)
# do PCA
coffee.pca <- opls(LES, plotL = FALSE, printL = FALSE)
```

**Score plot:**

```{r message=FALSE, warning=FALSE}
# plot_pca(coffee.pca, group_var = coffee$site)
plot_pca(coffee.pca, group_var = coffee$treatment)
```

**Loadings (correlations):**

```{r}
plot(coffee.pca, typeVc = "correlation")
```

This matches the bi-plot figure in the publication.  There is little separation along PC1, which recapitulates the LES (I think?) and no separation along PC2 which represents water use and transpiration.

```{r}
coffee.pls <- opls(LES, coffee$treatment, permI = 500)
get_loadings(coffee.pls) %>% arrange(desc(abs(p1)))
opls(LES, coffee$site)
```
Poor performing models for both site and treatment.  No difference in treatment.


# Kitchen Sink analysis
Using all the variables, looking for site differences instead of treatment.

```{r}
kitchen_sink <-
  coffee %>% 
  select(plantht_cm, branchht_cm, sproutd_mm, stumpd_mm, num_leaves, num_fruits, area_m2, thick_mm, wt_mg, amax, trans, vpd, temp, rh, ac_ci, ci, leafcn, cond, wue, lma_g_m2, amass, leaf_density_g_cm3, leafn, leafc, area_cm2, soil_p, soil_n, soil_c, soil_ph, soil_moist)

kitchen_sink <-
  coffee %>% 
  select(vpd, temp, rh, ac_ci, ci, soil_p, soil_n, soil_c, soil_ph, soil_moist)
```

```{r}
pca_all <- opls(kitchen_sink, plotL = FALSE, printL = FALSE)
```

```{r}
plot_pca(pca_all, coffee$site)
get_loadings(pca_all) %>% 
  arrange(desc(abs(p1)))
```
```{r}
pls_site <- opls(kitchen_sink, coffee$site, plotL = FALSE, printL = FALSE)
get_VIP(pls_site) %>% arrange(desc(VIP))
get_loadings(pls_site) %>% arrange(desc(abs(p1)))
plot_plsda(pls_site)
```

So there is some separation of catie, llano, and masatepe along P2.  The VIP variables differ from the PCA loadings for PC1