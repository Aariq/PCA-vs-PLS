---
title: "PCA vs. PLS-DA"
author: "Eric R. Scott"
output: html_notebook
---

This generates figure 2 showing the correlation structure and results from PCA-LR and PLS-DA for example datasets from the three scenarios.

**IMPORTANT:** The random number generator in R was updated in version 3.6.0.  For this to be fully reproducible, run with version > 3.6.0

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ropls) #for opls(), which does pca and pls-da
library(cowplot) #for plot_grid()
theme_set(theme_gray())
library(here)
library(colorspace)
source(here("R", "ropls_plots.R"))
source(here("R", "ropls_helpers.R"))
source(here("R", "pcr.R"))
library(glue)
library(latex2exp)
```


# Read in datasets
I'll read in the datasets from "3-generating-datasets.Rmd" and pick individual datasets to make figures

```{r}
null.list <- read_rds(here::here("data", "null.rds"))
control.list <- read_rds(here::here("data", "control.rds"))
needle.list <- read_rds(here::here("data", "needle.rds"))
herring.list <- read_rds(here::here("data", "red_herring.rds"))
```

Sample one dataset as an example

```{r}
# set.seed(719)
set.seed(720)
null <- sample(null.list, 1)[[1]]
needle <- sample(needle.list, 1)[[1]]
control <- sample(control.list, 1)[[1]]
herring <- sample(herring.list, 1)[[1]]
```

# Null

## Correlation heatmap for Null

```{r}
null.cor <-
  null %>% 
  select(-group) %>% 
  cor() %>%
  as_tibble(rownames = "row") %>% 
  gather(-row, key = col, value = cor)

null.cor.p <-
  ggplot(null.cor, aes(x = col, y = row, fill = cor)) +
  geom_tile() +
  scale_fill_continuous_diverging(palette = "Blue-Red 3", limits = c(-1,1)) +
  labs(x = NULL, y = NULL, subtitle = '"No predictors"', fill = "r") +
  theme_minimal() +
  theme(legend.position = "right")

# Replace axis labels with curly braces to improve readability:
b <- bracketsGrob(0.995, 0, 0.005, 0, h = 0.05)

bracket_labels <- tibble(x = 13, y = -1.75, label = "N")

null.cor.p <-
  null.cor.p +
  coord_cartesian(ylim = c(1,25), clip = "off") + #allows brackets to show up off plot
  theme(
    axis.text = element_blank(), #turns off axis labels
    axis.ticks = element_blank(), #turns off axis ticks
    plot.margin = unit(c(1,1,1.5,1), "lines") #padds margin to make room
  ) +
  annotation_custom(b) +
  geom_text(data = bracket_labels, inherit.aes = FALSE, aes(x=x, y=y, label = label))

null.cor.p
```


## PCA and PLS-DA for Null

```{r}
null.pcalr <- pca_lr(null, -group, group, predI = 2, CV = 7)
null.pca <- null.pcalr$pca
null.pls <- opls(select(null, -group), null$group, fig.pdfC = "none", permI = 500, predI = 2)
```

## Create plots for Null

```{r message=FALSE, warning=FALSE}
null.pca.p <-
  plot_pca(null.pca, null$group, annotate = "subtitle") +
  labs(title = NULL,
       subtitle =TeX(glue("$R^2_Y = {signif(null.pcalr$mod.stats$R2Y, 2)}$; $p = {signif(null.pcalr$mod.stats$p.value, 2)}$"))) +
  scale_color_discrete_qualitative(palette = "Dark 3")

null.pls.p <-
  plot_plsda(null.pls, annotate = "subtitle") +
  scale_color_discrete_qualitative(palette = "Dark 3")
null.pca.p
null.pls.p
```


# Needle in a haystack

## Correlation heatmap for needle-in-a-haystack

```{r}
needle.cor <-
  needle %>% 
  select(-group) %>% 
  cor() %>%
  as_tibble(rownames = "row") %>%  
  gather(-row, key = col, value = cor)

needle.cor.p <-
  ggplot(needle.cor, aes(x = col, y = row, fill = cor)) +
  geom_tile() +
  scale_fill_continuous_diverging(palette = "Blue-Red 3", limits = c(-1,1)) +
  labs(x = NULL, y = NULL, subtitle = '"Hidden predictors"', fill = "r") +
  theme_minimal() +
  theme(legend.position = "right")

b1 <- bracketsGrob(10/25, 0, 0.005, 0, h = 0.05)
b2 <- bracketsGrob(20/25, 0, 10/25, 0, h = 0.05)
b3 <- bracketsGrob(0.995, 0, 20/25, 0, h = 0.05)

bracket_labels <- tibble(x = c(5.5, 15.5, 23), #where to put labels on x-axis
                         y = rep(-1.75, 3), #how far below bracket to place labels
                         label = c("C1", "C2", "D")) #labels for groups of variables

needle.cor.p <-
  needle.cor.p +
  coord_cartesian(ylim = c(1,25), clip = "off") + #allows brackets to show up off plot
  theme(
    axis.text = element_blank(), #turns off axis labels
    axis.ticks = element_blank(), #turns off axis ticks
    plot.margin = unit(c(1,1,1.5,1), "lines") #pads margin to make room
  ) +
  annotation_custom(b1) +
  annotation_custom(b2) +
  annotation_custom(b3) +
  geom_text(data = bracket_labels, inherit.aes = FALSE, aes(x=x, y=y, label = label))
needle.cor.p
```

## PCA and PLS-DA for needle-in-a-haystack

The PCA score plot still shows no real separation because the discriminating variables do not contribute much to the total covariation in the data.  The PLS-DA plot shows very strong separation, despite the differences between the groups being only due to 5 out of 25 variables.  The PLS-DA model performs well, with high R^2^ and Q^2^ values

```{r include=FALSE}
needle.pcalr <- pca_lr(needle, -group, group, predI = 2, CV = 7)
needle.pca <- needle.pcalr$pca
needle.pls <- opls(select(needle, -group), needle$group, fig.pdfC = "none", predI = 2, permI = 500)
```

## Plots for needle-in-a-haystack

```{r message=FALSE, warning=FALSE}
needle.pca.p <-
  plot_pca(needle.pca, needle$group, annotate = "subtitle") +
  labs(title = NULL,
       subtitle =TeX(glue("$R^2_Y = {signif(needle.pcalr$mod.stats$R2Y, 2)}$; $p = {signif(needle.pcalr$mod.stats$p.value, 2)}$"))) +
  scale_color_discrete_qualitative(palette = "Dark 3")

needle.pls.p <-
  plot_plsda(needle.pls, annotate = "subtitle") +
  scale_color_discrete_qualitative(palette = "Dark 3")
needle.pca.p
needle.pls.p
```


# Control

## Correlation heatmap for Control

```{r}
control.cor <-
  control %>% 
  select(-group) %>% 
  cor() %>%
  as_tibble(rownames = "row") %>% 
  gather(-row, key = col, value = cor)

control.cor.p <-
  ggplot(control.cor, aes(x = col, y = row, fill = cor)) +
  geom_tile() +
  scale_fill_continuous_diverging(palette = "Blue-Red 3", limits = c(-1,1)) +
  labs(x = NULL, y = NULL, subtitle = '"Apparent predictors"', fill = "r") +
  theme_minimal()

b1 <- bracketsGrob(10/25, 0, 0.005, 0, h = 0.05)
b2 <- bracketsGrob(20/25, 0, 10/25, 0, h = 0.05)
b3 <- bracketsGrob(0.995, 0, 20/25, 0, h = 0.05)

bracket_labels <- tibble(x = c(5.5, 15.5, 23), #where to put labels on x-axis
                         y = rep(-1.75, 3), #how far below bracket to place labels
                         label = c("D1", "D2", "N")) #labels for groups of variables
control.cor.p <-
  control.cor.p +
  coord_cartesian(ylim = c(1,25), clip = "off") + #allows brackets to show up off plot
  theme(
    axis.text = element_blank(), #turns off axis labels
    axis.ticks = element_blank(), #turns off axis ticks
    plot.margin = unit(c(1,1,1.5,1), "lines") #padds margin to make room
  ) +
  annotation_custom(b1) +
  annotation_custom(b2) +
  annotation_custom(b3) +
  geom_text(data = bracket_labels, inherit.aes = FALSE, aes(x=x, y=y, label = label))
control.cor.p
```

## PCA and PLS-DA for Control

```{r include=FALSE}
control.pcalr <- pca_lr(control, -group, group,  CV = 7, predI = 2) 

control.pca <- control.pcalr$pca
control.pls <- opls(select(control, -group), control$group, fig.pdfC = "none", predI = 2, permI = 500)
```

## Plots for Control

```{r message=FALSE, warning=FALSE}
control.pca.p <-
  plot_pca(control.pca, control$group, annotate = "subtitle") +
  labs(title = NULL,
       subtitle =TeX(glue("$R^2_Y = 0.99$; $p < 0.001$"))) +
  scale_color_discrete_qualitative(palette = "Dark 3")

control.pls.p <-
  plot_plsda(control.pls, annotate = "subtitle") +
  scale_color_discrete_qualitative(palette = "Dark 3")
control.pca.p
control.pls.p
```
# Red Herring

## Correlation heatmap for Red Herring

```{r}
herring.cor <-
  herring %>% 
  select(-group) %>% 
  cor() %>%
  as_tibble(rownames = "row") %>% 
  gather(-row, key = col, value = cor)

herring.cor.p <-
  ggplot(herring.cor, aes(x = col, y = row, fill = cor)) +
  geom_tile() +
  scale_fill_continuous_diverging(palette = "Blue-Red 3", limits = c(-1,1)) +
  labs(x = NULL, y = NULL, subtitle = '"Red Herring"', fill = "r") +
  theme_minimal()

b1 <- bracketsGrob(10/25, 0, 0.005, 0, h = 0.05)
b2 <- bracketsGrob(20/25, 0, 10/25, 0, h = 0.05)
b3 <- bracketsGrob(0.995, 0, 20/25, 0, h = 0.05)

bracket_labels <- tibble(x = c(5.5, 15.5, 23), #where to put labels on x-axis
                         y = rep(-1.75, 3), #how far below bracket to place labels
                         label = c("C1", "C2", "N")) #labels for groups of variables
herring.cor.p <-
  herring.cor.p +
  coord_cartesian(ylim = c(1,25), clip = "off") + #allows brackets to show up off plot
  theme(
    axis.text = element_blank(), #turns off axis labels
    axis.ticks = element_blank(), #turns off axis ticks
    plot.margin = unit(c(1,1,1.5,1), "lines") #padds margin to make room
  ) +
  annotation_custom(b1) +
  annotation_custom(b2) +
  annotation_custom(b3) +
  geom_text(data = bracket_labels, inherit.aes = FALSE, aes(x=x, y=y, label = label))
herring.cor.p
```
## PCA and PLS-DA for Red Herring

```{r}
herring.pcalr <- pca_lr(herring, -group, group, predI = 2, CV = 7)
herring.pca <- herring.pcalr$pca
herring.pls <- opls(select(herring, -group), null$group, fig.pdfC = "none", permI = 500, predI = 2)
```

## Create plots for Null

```{r message=FALSE, warning=FALSE}
herring.pca.p <-
  plot_pca(herring.pca, null$group, annotate = "subtitle") +
  labs(title = NULL,
       subtitle =TeX(glue("$R^2_Y = {signif(herring.pcalr$mod.stats$R2Y, 2)}$; $p = {signif(herring.pcalr$mod.stats$p.value, 2)}$"))) +
  scale_color_discrete_qualitative(palette = "Dark 3")

herring.pls.p <-
  plot_plsda(herring.pls, annotate = "subtitle") +
  scale_color_discrete_qualitative(palette = "Dark 3")
herring.pca.p
herring.pls.p
```

# Make figure

## Three Scenarios
Put Null, Control, and Needle together to make a figure.

```{r}
fix_theme_cor <-
  theme(plot.subtitle = element_text(hjust = 0.5))

fix_theme_score <-
  theme(legend.position = "none",
        plot.title = element_blank(),
        panel.grid = element_blank())
```

```{r}
library(patchwork)
# null.cor.p + control.cor.p + needle.cor.p + plot_layout(guides = "collect")
# guides = "collect" currently broken with R 4.0.0, workaround until patchwork update:
null.cor.p <- null.cor.p + theme(legend.position = "none")
control.cor.p <- control.cor.p + theme(legend.position = "none")

(null.cor.p + control.cor.p + needle.cor.p & fix_theme_cor) /
  (null.pca.p + control.pca.p + needle.pca.p & fix_theme_score) /
  (null.pls.p + control.pls.p + needle.pls.p & fix_theme_score) +
  plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")")
ggsave(here("out", "three-scenarios.png"), width = 10, height = 9)
```

# Biplots

Make biblots for each scenario for supplemental.


## No predictors bi-plot

Get data and scale scores and loadings

```{r}
null.pca.stats <- get_modelinfo(null.pca)
null.pcalr

null.pca.load <-
  get_loadings(null.pca) %>% 
  mutate(p1 = ss_scale(p1, null.pca.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, null.pca.stats$axis_stats$R2X[2]))
  
null.pca.score <-
  get_scores(null.pca) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
library(ggrepel)
ggplot(null.pca.load) +
  geom_point(data = null.pca.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(data = null.pca.load, 
                   aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("PC1 ({null.pca.stats$axis_stats[1,1] * 100}%)"),
       y = glue("PC2 ({null.pca.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "null pca biplot.png"))
```


```{r}
null.pls.stats <- get_modelinfo(null.pls)

null.pls.load <-
  get_loadings(null.pls) %>% 
  mutate(p1 = ss_scale(p1, null.pls.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, null.pls.stats$axis_stats$R2X[2]))
  
null.pls.score <-
  get_scores(null.pls) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
library(ggrepel)
ggplot(null.pls.load) +
  geom_point(data = null.pls.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(data = null.pls.load, 
                   aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("P1 ({null.pls.stats$axis_stats[1,1] * 100}%)"),
       y = glue("P2 ({null.pls.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "null pls biplot.png"))
```

## Apparent predictors

```{r}
control.pca.stats <- get_modelinfo(control.pca)

control.pca.load <-
  get_loadings(control.pca) %>% 
  mutate(p1 = ss_scale(p1, control.pca.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, control.pca.stats$axis_stats$R2X[2]))
  
control.pca.score <-
  get_scores(control.pca) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
ggplot(control.pca.load) +
  geom_point(data = control.pca.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("PC1 ({control.pca.stats$axis_stats[1,1] * 100}%)"),
       y = glue("PC2 ({control.pca.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "control pca biplot.png"))
```
```{r}
control.pls.stats <- get_modelinfo(control.pls)

control.pls.load <-
  get_loadings(control.pls) %>% 
  mutate(p1 = ss_scale(p1, control.pls.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, control.pls.stats$axis_stats$R2X[2]))
  
control.pls.score <-
  get_scores(control.pls) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
ggplot(control.pls.load) +
  geom_point(data = control.pls.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("P1 ({control.pls.stats$axis_stats[1,1] * 100}%)"),
       y = glue("P2 ({control.pls.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "control pls biplot.png"))
```
## Hidden predictors
```{r}
needle.pca.stats <- get_modelinfo(needle.pca)

needle.pca.load <-
  get_loadings(needle.pca) %>% 
  mutate(p1 = ss_scale(p1, needle.pca.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, needle.pca.stats$axis_stats$R2X[2]))
  
needle.pca.score <-
  get_scores(needle.pca) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
ggplot(needle.pca.load) +
  geom_point(data = needle.pca.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("PC1 ({needle.pca.stats$axis_stats[1,1] * 100}%)"),
       y = glue("PC2 ({needle.pca.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "needle pca biplot.png"))
```


```{r}
needle.pls.stats <- get_modelinfo(needle.pls)

needle.pls.load <-
  get_loadings(needle.pls) %>% 
  mutate(p1 = ss_scale(p1, needle.pls.stats$axis_stats$R2X[1]),
         p2 = ss_scale(p2, needle.pls.stats$axis_stats$R2X[2]))
  
needle.pls.score <-
  get_scores(needle.pls) %>% 
  mutate_if(is.numeric, ss_scale) %>% 
  add_column(group = rep(c("a", "b"), each = 10))
```

```{r fig.height=3.5, fig.width=4.5}
ggplot(needle.pls.load) +
  geom_point(data = needle.pls.score,
             aes(x = p1, y = p2, color = group),
             size = 2) +
  geom_segment(aes(x = 0, y = 0, xend = p1, yend = p2),
               arrow = arrow(length = unit(0.15, "cm"))) +
  geom_label_repel(aes(x = p1, y = p2, label = Variable),
                   segment.alpha = 0.6, size = 2.7, 
                   min.segment.length = 0) +
  labs(x = glue("P1 ({needle.pls.stats$axis_stats[1,1] * 100}%)"),
       y = glue("P2 ({needle.pls.stats$axis_stats[2,1] * 100}%)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        text = element_text(size = 14))
ggsave(here("out", "supplemental", "needle pls biplot.png"))
```