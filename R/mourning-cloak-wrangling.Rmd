---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(glue)
```

# To-Do:

- get weather data from 1989--2011 so when I lag it, I don't have to get rid of a year of butterfly data


Weather data from [NOAA Climate at a Glance](https://www.ncdc.noaa.gov/cag/statewide/time-series/)

```{r}
raw <- list.files(here::here("data", "mourning-cloaks"), "^19", full.names = TRUE) %>% 
  map(~read_csv(., col_types = "dd") %>% 
        rename(ym = "Massachusetts") %>%
        filter(!is.na(ym))) %>% 
  reduce(., left_join, by = "ym") %>% 
  mutate(year = str_extract(ym, "^\\d{4}") %>% as.numeric(),
         month = str_extract(ym, "\\d{2}$")) %>% 
  mutate(month = month.abb[as.numeric(month)]) %>% 
  select(year, month, everything()) %>% 
  select(-ym) %>%
  janitor::clean_names() %>% 
  rename(pdsi = "palmer_drought_severity_index_pdsi", avg_temp = "average_temperature", max_temp = "maximum_temperature", min_temp = "minimum_temperature", precip = "precipitation")
raw
```

split combine

```{r}
all_the_vars <-
  raw %>%
  split(.$month) %>% 
  map2(.x = ., .y = names(.),
       ~rename_at(.x,vars(-year, -month), funs(glue("{.y}_{.}")))) %>% 
  map(~select(., -month)) %>% 
  reduce(., left_join, by = "year")

write_csv(all_the_vars, here::here("data", "mourning-cloaks", "monthly weather.csv"))
```

summarize, split, combine, add a lagged fall column

Elizabeth counted jan feb march as winter

```{r}
seasonal_summary <-
  raw %>% 
  mutate(season = case_when(month %in% c("Jan", "Feb", "Mar")  ~ "Wi",
                            month %in% c("Apr", "May", "Jun")  ~ "Sp",
                            month %in% c("Jul", "Aug", "Sep")  ~ "Su",
                            month %in% c("Oct", "Nov", "Dec")  ~ "Au")) %>% 
  select(year, month, season, everything()) %>% 
  select(-month) %>% 
  group_by(year, season) %>% 
  summarize(sum_cdd = sum(cooling_degree_days),
            sum_hdd = sum(heating_degree_days),
            sum_precip = sum(precip),
            mean_pdsi = mean(pdsi),
            mean_avg_temp = mean(avg_temp),
            mean_max_temp = mean(max_temp),
            mean_min_temp = mean(min_temp)) %>% 
  split(.$season) %>% 
  map2(.x = ., .y = names(.),
       ~rename_at(.x,vars(-year, -season), funs(glue("{.y}_{.}")))) %>% 
  map(~select(., -season)) %>% 
  reduce(., left_join, by = "year")

#add columns for the previous autumn and remove 1990 (since I don't have data for 1989)
season_data <-
  seasonal_summary %>% 
  ungroup() %>% 
  mutate_at(vars(starts_with("Au")), funs(prev = lag)) %>% 
  slice(-1)

write_csv(season_data, here::here("data", "mourning-cloaks", "seasonal weather.csv"))
```

read in mourning cloak data and join

```{r}
mocl <-
  read_csv(here::here("data", "mourning-cloaks", "MOCLclim.csv")) %>% 
  select(year, MOCL, MOCL_fall) %>%
  filter(!is.na(year)) #remove last row of NAs
```

```{r}
mocl1 <- left_join(mocl, season_data)
```







