---
title: "NEON data wrangling"
output: html_notebook
---
```{r}
library(tidyverse)
library(here)
library(neonUtilities)
```
After chatting with Katie at NEON, we decided a good place to start would be with small mammal data and vegetation data.  She recommended three data products: the small mammal trapping data which is capture-recapture data collected monthly and includes morphology measures and tick counts; the plant presence and percent cover data product which includes presence and percent cover of different plant species; and Woody Plant Vegetation Structure which includes morphological measures of woody plants

Let's start with woody plants.  This dataset is measured every three years, so I'll get three years of data from a bunch of sites and collapse it down somehow.
```{r}
# stackByTable(here("data", "NEON", "NEON_struct-woody-plant.zip")) # only need to run once
stackByTable(here("data", "NEON", "NEON_presence-cover-plant.zip")) # only need to run once
```

# Vegetation structure

```{r}
struct <- read_csv(here("data", "NEON", "NEON_struct-woody-plant", "stackedFiles", "vst_apparentindividual.csv"))
```

```{r}
struct %>% 
  filter(!is.na(stemDiameter),
         !is.na(height),
         plantStatus == "Live") %>% 
  group_by(individualID) %>% 
  summarise(namedLocation = first(namedLocation),
            stemDiameter = mean(stemDiameter),
            height = mean(height))
```
Hmm, not useful on its own really


# Plant cover

I'm using the 1 meter square data because that's what Kate suggested.  I'm not sure what the other file is

```{r}
cover <- read_csv(here("data", "NEON", "NEON_presence-cover-plant", "stackedFiles", "div_1m2Data.csv"))
```

So `cover` is either a focal plant species (`taxonID`) or an "other variabe" (`otherVariables`) such as litter, wood, moss, bare soil.  I should combine these columns (after checking that its one or the other always) and then spread them.

```{r}
cover %>% 
  filter(!is.na(otherVariables) & !is.na(taxonID))
# zero rows have both kinds of variables
cover %>% 
  filter(is.na(otherVariables) & is.na(taxonID))
#filter these out, they are NAs in all important columns
```
```{r}
cover1 <-
  cover %>% 
  filter(!(is.na(otherVariables) & is.na(taxonID)))
```

Let's check how many unique plots this is

```{r}
cover1 %>% 
  group_by(plotID) %>% 
  count()
```

313 plots.  Ok, not so HUGE, but pretty big.  WOuld be nice to get this number under 100 while maintaining a big range in elevation and lattitude.  Let's see what I can figure out about each site

```{r}
cover1 %>% 
  group_by(siteID) %>% 
  summarize(elev_range = max(elevation) - min(elevation)) %>% 
  arrange(desc(elev_range))
```
Ok, looks like the first 4 sites have a big range in elevation, so I'll just use those.
At some point, I should figure out where these are.
```{r}
cover2 <-
  cover1 %>% 
  filter(siteID %in% c("BART", "SCBI", "HARV", "GUAN"))
```

## combine and spread
```{r}
cover.wide <-
  cover2 %>% 
  select(namedLocation, siteID, decimalLatitude, decimalLongitude, elevation, plotID, subplotID, endDate, taxonID, otherVariables, percentCover) %>% 
  mutate(variable = case_when(!is.na(taxonID) ~ taxonID,
                              !is.na(otherVariables) ~ otherVariables,
                              TRUE ~ as.character(NA))) %>% 
  select(-taxonID, -otherVariables) %>% 
  group_by(namedLocation, variable) %>% 
  summarize(siteID = first(siteID),
            meanElevation = mean(elevation, na.rm = TRUE),
            meanLatitude = mean(decimalLatitude, na.rm = TRUE),
            meanLongitude = mean(decimalLongitude, na.rm = TRUE),
            meanPercentCover = mean(percentCover, na.rm = TRUE)) %>% 
  spread(key = variable, value = meanPercentCover) %>% 
  ungroup()
```

```{r}
cover.wide
```
Oh, that's a lot of NAs.  Let's get rid of some columns?

```{r}
# cover.wide %>% 
  # summarize_all(funs(sum(!is.na(.))))

test <-
  cover.wide %>% 
  select_if(funs(sum(!is.na(.)) > 10))
```

Hmm, maybe just one site? Maybe HARV?

```{r}
harv <- cover.wide %>% 
  filter(siteID == "HARV") %>% 
  select_if(funs(sum(!is.na(.)) > 10))
```


#try pca and plsr

```{r}
library(ropls)
```

```{r}
meta <- c("siteID", "namedLocation", "meanElevation", "meanLatitude", "meanLongitude")
test.pca <- opls(select(test, -meta))
test.pls <- opls(select(test, -meta), test$siteID)
```

```{r}
harv.pca <- opls(select(harv, -meta))
harv.pls <- opls(select(harv, -meta), harv$meanElevation)
```
Not sure what this error message means, but it's clearly triggering code that happens when R2Y is less than 0.01, so very bad model.


# Try something with litter cover

```{r}
harv.litter <- 
  harv %>% 
  mutate(litter = replace_na(litter, 0))
X <- harv.litter %>% 
  select(-meta) %>% 
  select(-litter)
opls(X, harv.litter$litter)
```
NOPE
