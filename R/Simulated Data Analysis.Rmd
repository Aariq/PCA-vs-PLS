---
title: "Simulated data analysis"
output: html_notebook
---
# Goal
To show that PLS-DA performs better than PCA at figuring out which variables are most responsible for group separation.  I do this using VIP scores from PLS-DA and correlations with PC1 for PCA followed by a calculation of Cohen's Kappa.  For now, I'm only doing this with two of the data scenarios where the variables either contribute to group separation or don't: the positive control, and the needle-in-a-haystack.

For each dataset:

- Do PCA
- Do PLS-DA
- Calculate Cohen's Kappa for each method as outlined in "Confusion Matrix.Rmd"
- Plot distributions of Cohen's Kappa
- Possibly do other stuff like:
    + compare p-values from PCA score based t-tests and PLS-DA permutation tests
    + calculate distance between centriods in score plots for PCA and PLS-DA for all datasets
    
    
# Packages and Functions

```{r}
library(here)
library(chemhelper)
library(ropls)
library(psych) #for cohen.kappa()
library(tidyverse)
```
```{r}
#create "safe" version of opls() which returns NULL if it errors
safe_opls <- possibly(opls, otherwise = NULL)
```

# Load Data

```{r}
# null <- read_rds(here("data", "null.rds"))
needle <- read_rds(here("data", "needle.rds"))
# red_herring <- read_rds(here("data", "red herring.rds"))
control <- read_rds(here("data", "control.rds"))
```


# Control

## Fit PCA models

```{r}
control.pcas.try <-
  map(control,
      ~safe_opls(select(., -group), plotL = FALSE, printL = FALSE))
control.pcas.failed <- map_lgl(control.pcas.try, is.null)
control.pcas <- control.pcas.try[!control.pcas.failed]
```

## Fit PLS models

- Not increasing the number of permutation for now, because I'm not concerned about p-values yet.
- Many models fail for the null, which makes sense.  What to do?
    + Force 2 axes?
    + Force 1 axis?
    + Do OPLS-DA with one axis forced?
    + Just look at the models that actually get built?

Currently, this just picks the ones that worked (at least one component built)

```{r}
control.pls.try <-
  map(control,
      ~ safe_opls(select(., -group), .$group, plotL = FALSE, printL = FALSE))
control.pls.failed <- map_lgl(control.pls.try, is.null)
control.pls <- control.pls.try[!control.pls.failed]
```

## Calculate Cohen's Kappa

- For PCA, I'm defining an "important" variable as one with a correlation to PC1 > 0.5 or  < -0.5
- For PLS, an "important" variable is one with a VIP score > 1

### PCA kappas

```{r message=FALSE, warning=FALSE}
# Get correlations
control.cors <-
  map2(.x = control.pcas,
       #filter .y by getting rid of models that didn't run
       .y = control[!control.pcas.failed], 
       #correlation between axis scores and data
       ~ cor(get_scores(.x)[2:3], select(.y, -group)) %>% 
         t() %>% 
         as_data_frame(rownames = "Variable")) %>% 
  # calculate distance from center in correlation units for each variable
  map(~ rowwise(.) %>% 
        mutate(distance = sqrt(sum((c(p1, p2) - c(0, 0))^2))) %>% 
        # if corr distance > 0.5, then its "important" variable
        mutate(#detect_discr = ifelse(distance > 0.5, TRUE, FALSE),
               detect_discr = ifelse(abs(p1) > 0.5, TRUE, FALSE),
               is_discr = ifelse(str_detect(Variable, "discr"), TRUE, FALSE))
        )

# calculate kappa
control.pca.k <- 
  map_dfr(control.cors,
      ~ select(., detect_discr, is_discr) %>%
        as.matrix() %>%
        cohen.kappa() %>%
        .$kappa %>%
        data_frame(pca.k = .),
      .id = "dataset")
```


### PLS-DA kappas

```{r message=FALSE, warning=FALSE}
# Get VIP scores
control.vips <-
  map(control.pls,
      ~ get_VIP(.) %>% 
        mutate(detect_discr = ifelse(VIP > 1, TRUE, FALSE),
               is_discr = ifelse(str_detect(Variable, "discr"), TRUE, FALSE)))

control.pls.k <- 
  map_dfr(control.vips,
      ~ select(., detect_discr, is_discr) %>%
        as.matrix() %>%
        cohen.kappa() %>%
        .$kappa %>%
        data_frame(pls.k = .),
      .id = "dataset")
```

### Join all kappas

```{r}
control.k <- full_join(control.pca.k, control.pls.k)
```

### Build Plot
```{r colors}
mycolors <- c("PCA" = "#C1383A", "PLS-DA" = "#1F46A3")
```

```{r}
control.k.plotdata <-
  control.k %>%
  gather(-dataset, key = "Method", value = "Cohen's Kappa") %>% 
  mutate(Method = as.factor(Method) %>% fct_recode(PCA = "pca.k", `PLS-DA` = "pls.k"))

control.p <- ggplot(control.k.plotdata) +
  geom_histogram(aes(x = `Cohen's Kappa`, fill = Method),
                 position = "dodge", bins = 10) +
  scale_fill_manual("Method", values = mycolors) +
  theme_bw() +
  labs(x = "Cohen's Kappa", y = "Frequency")
```

# Needle-in-a-haystack

## Fit PCA models

```{r}
# map to all datasets in null scenario
needle.pcas.try <-
  map(needle,
      ~safe_opls(select(., -group), plotL = FALSE, printL = FALSE))
needle.pcas.failed <- map_lgl(needle.pcas.try, is.null)
needle.pcas <- needle.pcas.try[!needle.pcas.failed]
```

## Fit PLS models

- Not increasing the number of permutation for now, because I'm not concerned about p-values yet.
- Many models fail for the null, which makes sense.  What to do?
    + Force 2 axes?
    + Force 1 axis?
    + Do OPLS-DA with one axis forced?
    + Just look at the models that actually get built?

Currently, this just picks the ones that worked (at least one component built)

```{r}
needle.pls.try <-
  map(needle,
      ~ safe_opls(select(., -group), .$group, plotL = FALSE, printL = FALSE))
needle.pls.failed <- map_lgl(needle.pls.try, is.null)
needle.pls <- needle.pls.try[!needle.pls.failed]
```

## Calculate Cohen's Kappa

- For PCA, I'm defining an "important" variable as one with a correlation to PC1 > 0.5 or  < -0.5
- For PLS, an "important" variable is one with a VIP score > 1

### PCA kappas

```{r message=FALSE, warning=FALSE}
# Get correlations
needle.cors <-
  map2(.x = needle.pcas,
       #filter .y by getting rid of models that didn't run
       .y = needle[!needle.pcas.failed], 
       #correlation between axis scores and data
       ~ cor(get_scores(.x)[2:3], select(.y, -group)) %>% 
         t() %>% 
         as_data_frame(rownames = "Variable")) %>% 
  # calculate distance from center in correlation units for each variable
  map(~ rowwise(.) %>% 
        mutate(distance = sqrt(sum((c(p1, p2) - c(0, 0))^2))) %>% 
        # if corr distance > 0.5, then its "important" variable
        mutate(#detect_discr = ifelse(distance > 0.5, TRUE, FALSE),
               detect_discr = ifelse(abs(p1) > 0.5, TRUE, FALSE),
               is_discr = ifelse(str_detect(Variable, "discr"), TRUE, FALSE))
        )

# calculate kappa
needle.pca.k <- 
  map_dfr(needle.cors,
      ~ select(., detect_discr, is_discr) %>%
        as.matrix() %>%
        cohen.kappa() %>%
        .$kappa %>%
        data_frame(pca.k = .),
      .id = "dataset")
```


### PLS-DA kappas

```{r message=FALSE, warning=FALSE}
# Get VIP scores
needle.vips <-
  map(needle.pls,
      ~ get_VIP(.) %>% 
        mutate(detect_discr = ifelse(VIP > 1, TRUE, FALSE),
               is_discr = ifelse(str_detect(Variable, "discr"), TRUE, FALSE)))

needle.pls.k <- 
  map_dfr(needle.vips,
      ~ select(., detect_discr, is_discr) %>%
        as.matrix() %>%
        cohen.kappa() %>%
        .$kappa %>%
        data_frame(pls.k = .),
      .id = "dataset")
```

### Join all kappas

```{r}
needle.k <- full_join(needle.pca.k, needle.pls.k)
```

### Build plot

```{r}
needle.k.plotdata <-
  needle.k %>%
  gather(-dataset, key = "Method", value = "Cohen's Kappa") %>% 
  mutate(Method = as.factor(Method) %>% fct_recode(PCA = "pca.k", `PLS-DA` = "pls.k"))

needle.p <- ggplot(needle.k.plotdata) +
  geom_histogram(aes(x = `Cohen's Kappa`, fill = Method),
                 position = "dodge", bins = 10) +
  scale_fill_manual("Method", values = mycolors) +
  theme_bw() +
  labs(x = "Cohen's Kappa", y = "Frequency")
```

# Plot

```{r}
library(cowplot)
panels <- plot_grid(control.p + theme(legend.position = "none"),
          needle.p + theme(legend.position = "none"),
          nrow = 1,
          ncol = 2,
          labels = "auto")
fig2 <- plot_grid(panels, get_legend(control.p),
          rel_widths = c(1, 0.15))
save_plot(here("figs", "fig2.png"), fig2, ncol = 2)
```

