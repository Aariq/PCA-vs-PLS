---
title: "Simulated data analysis"
output: 
  html_notebook: 
    toc: yes
    toc_float: yes
---

# To-Do:


- ~~output PCAs and PLSs as .rds~~
- implement PCA regression on all scenarios, output PCR models.
- deprecate red herring scenario
- Add permutation to pls to get p-values.?
- move analysis of results to other notebook?

# Goal
To show that PLS-DA performs better than PCA at figuring out which variables are most responsible for group separation.  I do this using VIP scores from PLS-DA and correlations with PC1 for PCA followed by a calculation of Cohen's Kappa.  For now, I'm only doing this with two of the data scenarios where the variables either contribute to group separation or don't: the positive control, and the needle-in-a-haystack.

For each dataset:

- Do PCA
- Do PLS-DA
- Record how many PLS-DA's fail because even the first component is not significant, but filter out failing models
- Calculate Cohen's Kappa for each method as outlined in "Confusion Matrix.Rmd"
- Plot distributions of Cohen's Kappa
- Possibly do other stuff like:
    + compare p-values from PCA score based t-tests and PLS-DA permutation tests
    + calculate distance between centriods in score plots for PCA and PLS-DA for all datasets
    

# Packages and Functions

```{r message=FALSE, warning=FALSE}
library(here)
library(holodeck)
library(ropls)
library(psych) #for cohen.kappa()
library(tidyverse)
library(colorspace)
library(cowplot)
source(here("R","pcr.R"))
```

Create "safe" "partial" version of opls() which returns NULL if it errors and never plots or prints results

```{r}
safe_opls <- safely(partial(opls, printL = FALSE, plotL = FALSE), otherwise = NULL)
safe_pcr <- safely(pcreg, otherwise = NULL)
```

# Load Data

```{r}
null <- read_rds(here("data", "null.rds"))
needle <- read_rds(here("data", "needle.rds"))
# red_herring <- read_rds(here("data", "red herring.rds"))
control <- read_rds(here("data", "control.rds"))
```


# Run Analyses

For each scenario, run PCA and PLS-DA on all datasets.  Record errors, and calculate summary statistics on the models that are successfullly built

## Null

### Null PCAs

```{r}
# map the pca function to all datasets
null.pcas.try <-
  null %>% 
  map(~safe_opls(select(., -group)))

#try with my PCR function instead
null.pcr.try <- 
  null %>% 
  map(~safe_pcr(-group, group, data = .))

# Get just the successful models
null.pcas <-
  null.pcas.try %>%
  map("result") %>% #get only results
  discard(is.null) #get rid of any with NULL results (and therefore an error)
```

Any errors?

```{r}
length(null.pcas.try) - length(null.pcas)
```
Save em!

```{r}
write_rds(null.pcas, here("data", "models", "null-pca.rds"))
```

### Null PLSs

```{r}
null.pls.try <-
  null %>% 
  map(~ safe_opls(select(., -group), .$group, permI = 500)) #map the opls

# get just succesful models
null.pls <-
  null.pls.try %>% 
  map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(null.pls.try) - length(null.pls)
```

75/100 models failed.  Why?

```{r}
null.pls.try %>% 
  map("error") %>%
  unique()
```

They all failed because the first predictive component already wasn't significant.
```{r}
write_rds(null.pls, here("data", "models", "null-pls.rds"))
```

## Control

### Control PCAs

```{r}
# map the pca function to all datasets
control.pcas.try <-
  map(control,
      ~safe_opls(select(., -group)))

control.pcas <-
  control.pcas.try %>%
  map("result") %>% 
  discard(is.null)
```

How many errors? 

```{r}
length(control.pcas.try) - length(control.pcas)

#What was the error?
control.pcas.try %>% 
  map("error") %>% 
  unique()
```

One failed model due to convergence problems

Save em!

```{r}
write_rds(control.pcas, here("data", "models", "control-pca.rds"))
```


### Control PLS-DAs

```{r}
control.pls.try <-
  map(control,
      ~ safe_opls(select(., -group), .$group, permI = 500))

control.pls <-
  control.pls.try %>% 
  map("result") %>% 
  discard(is.null)
```

How many failed models?

```{r}
length(control.pls.try) - length(control.pls)
```

zero failed models

Save em!

```{r}
write_rds(control.pls, here("data", "models", "control-pls.rds"))
```

## Needle in a haystack

### Needle PCAs

```{r}
needle.pcas.try <-
  map(needle,
      ~safe_opls(select(., -group)))

needle.pcas <-
  needle.pcas.try %>% 
  map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(needle.pcas.try) - length(needle.pcas)
```

zero failed models 
```{r}
write_rds(needle.pcas, here("data", "models", "needle-pca.rds"))
```

### Needle PLS-DAs

```{r}
needle.pls.try <-
  map(needle,
      ~ safe_opls(select(., -group), .$group, permI = 500))

needle.pls <-
  needle.pls.try %>% 
  map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(needle.pls.try) - length(needle.pls)
```

zero errors

```{r}
write_rds(needle.pls, here("data", "models", "needle-pls.rds"))
```


## Red Herring (might not use this one)

### Red Herring PCAs

```{r}
herring.pcas.try <-
  map(red_herring,
      ~safe_opls(select(., -group)))

herring.pcas <-
  herring.pcas.try %>% 
  map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(herring.pcas.try) - length(herring.pcas)
```

Zero errors
```{r}
write_rds(herring.pcas, here("data", 'models', 'herring-pca.rds'))
```

### Red Herring PLS-DAs

```{r}
herring.pls.try <-
  map(red_herring,
      ~ safe_opls(select(., -group), .$group, permI = 500))

herring.pls <-
  herring.pls.try %>% 
  map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(herring.pls.try) - length(herring.pls)
```

Zero errors

```{r}
write_rds(herring.pls, here('data','models', 'herring-pls.rds'))
```

# Get Summary Stats
## Map R2 and Q2 extractor

**Control**

```{r}
control.pls %>%
  map(~get_modelinfo(.)) %>%
  map_dfr(~list(Q2 = pluck(., 2, "Q2(cum)"),
                R2 = pluck(., 2, "R2Y(cum)"),
                pR2 = pluck(., 2, "pR2Y"),
                pQ2 = pluck(., 2, "pQ2")),
          .id = "dataset") %>% 
  summarize_if(is.numeric, funs(mean, sd))
```

**Null**

```{r}
null.pls %>%
  map(~get_modelinfo(.)) %>%
  map_dfr(~list(Q2 = pluck(., 2, "Q2(cum)"),
                R2 = pluck(., 2, "R2Y(cum)"),
                pR2 = pluck(., 2, "pR2Y"),
                pQ2 = pluck(., 2, "pQ2")),
          .id = "dataset") %>% 
  summarize_if(is.numeric, funs(mean, sd))
```

**Needle-in-a-haystack**

```{r}
needle.pls %>%
  map(~get_modelinfo(.)) %>%
  map_dfr(~list(Q2 = pluck(., 2, "Q2(cum)"),
                R2 = pluck(., 2, "R2Y(cum)"),
                pQ2 = pluck(., 2, "pQ2")),
          .id = "dataset") %>% 
  summarize_if(is.numeric, funs(mean, sd))
```

**Red Herring**

```{r}
herring.pls %>%
  map(~get_modelinfo(.)) %>%
  map_dfr(~list(Q2 = pluck(., 2, "Q2(cum)"),
                R2 = pluck(., 2, "R2Y(cum)"),
                pQ2 = pluck(., 2, "pQ2")),
          .id = "dataset") %>% 
  summarize_if(is.numeric, funs(mean, sd))
```





