---
title: "Simulated data analysis"
author: "Eric R. Scott"
output: 
  html_notebook: 
    toc: yes
    toc_float: yes
---

# Overview
For each simulated dataset in each of the three scenarios:

- Do PCA logistic regression
- Do PLS-DA
- Store results
  

# Packages and Functions

```{r message=FALSE, warning=FALSE}
library(here)
library(ropls)
library(tidyverse)
library(furrr) #for parallelization
source(here("R","pcr.R"))
# source(here("R", "RMSEP.R"))  #needed?
# runif(1, 0, 1000)
set.seed(690)
```

Set up parallelization

```{r include=FALSE}
plan(multiprocess)
```


Create "safe" "partial" version of `opls()` which returns `NULL` if it errors and never plots or prints results.

```{r}
safe_opls <- safely(partial(opls, info.txtC = "none", fig.pdfC = "none"), otherwise = NULL)
safe_pcr <- safely(pca_lr, otherwise = NULL)
```

# Load Data

```{r}
null <- read_rds(here("data", "null.rds"))
needle <- read_rds(here("data", "needle.rds"))
control <- read_rds(here("data", "control.rds"))
herring <- read_rds(here("data", "red_herring.rds"))
```


# Null

## Null PCAs

```{r}
null.pcr.try <- 
  null %>% 
  future_map(~safe_pcr(.x, -group, group, CV = 7))

# Get just the successful models
null.pcr <-
  null.pcr.try %>%
  future_map("result") %>% #get only results
  discard(is.null) #get rid of any with NULL results (and therefore an error)
```

Any errors?

```{r}
length(null.pcr.try) - length(null.pcr)
null.pcr.try %>% 
  map("error") %>%
  unique()
```

3 errors in PCA part, but also several convergence warnings in GLM part.

Save em!

```{r}
write_rds(null.pcr, here("data", "models", "null-pcr.rds"))
```

## Null PLSs

```{r}
null.pls.try <-
  null %>% 
  future_map(~ safe_opls(select(., -group), .$group, permI = 500)) #map the opls

# get just succesful models
null.pls <-
  null.pls.try %>% 
  future_map("result") %>% 
  discard(is.null) 

# with one component forced
null.pls.force <-
  null %>% 
  future_map(~ safe_opls(select(., -group), .$group, predI = 1, permI = 500)) %>% 
  future_map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(null.pls.try) - length(null.pls)
```

398/500 models failed.  Why?

```{r}
null.pls.try %>% 
  map("error") %>%
  unique()
```

They all failed because the first predictive component already wasn't significant.

```{r}
write_rds(null.pls, here("data", "models", "null-pls.rds"))
write_rds(null.pls.force, here("data", "models", "null-pls-force.rds"))
```

# Control

## Control PCAs

```{r message=FALSE, warning=FALSE}
# map the pca function to all datasets
control.pcr.try <-
  future_map(control,
      ~safe_pcr(.x, -group, group, CV = 7))

control.pcr <-
  control.pcr.try %>%
  future_map("result") %>% 
  discard(is.null)
```

This gives a bunch of convergence warnings, but it's just because fitted values are perfectly 0 or 1, which is safe to ignore (I believe).

How many errors? 

```{r}
length(control.pcr.try) - length(control.pcr)

#What was the error?
control.pcr.try %>% 
  future_map("error") %>% 
  unique()
```

No errors.

Save em!

```{r}
write_rds(control.pcr, here("data", "models", "control-pcr.rds"))
```


## Control PLS-DAs

```{r}
control.pls.try <-
  future_map(control,
      ~ safe_opls(select(., -group), .$group, permI = 500))

control.pls <-
  control.pls.try %>% 
  future_map("result") %>% 
  discard(is.null) 

# with one component forced (the average)
control.pls.force <-
  future_map(control,
      ~ safe_opls(select(., -group), .$group, predI = 1, permI = 500)) %>% 
  future_map("result") %>% 
  discard(is.null) 
```

How many failed models?

```{r}
length(control.pls.try) - length(control.pls)
```

zero failed models

Save em!

```{r}
write_rds(control.pls, here("data", "models", "control-pls.rds"))
write_rds(control.pls.force, here("data", "models", "control-pls-force.rds"))
```

# Needle in a haystack

## Needle PCAs

```{r message=FALSE, warning=FALSE}
needle.pcr.try <-
  future_map(needle,
      ~safe_pcr(.x, -group, group, CV = 7))

needle.pcr <-
  needle.pcr.try %>% 
  future_map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(needle.pcr.try) - length(needle.pcr)
#What was the error?
needle.pcr.try %>% 
  future_map("error") %>% 
  unique()
```

3 failed models due to the PCA part failing (exactly singular error)

```{r}
write_rds(needle.pcr, here("data", "models", "needle-pcr.rds"))
```

## Needle PLS-DAs

```{r}
needle.pls.try <-
  future_map(needle,
      ~ safe_opls(select(., -group), .$group, permI = 500))

needle.pls <-
  needle.pls.try %>% 
  future_map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(needle.pls.try) - length(needle.pls)
```

zero errors

How many components on average?

```{r}
future_map_dbl(needle.pls, ~ getSummaryDF(.x)$pre) %>% mean()
```

Round up to 2?


```{r}
# with 2 components (the average) forced
needle.pls.force <-
  future_map(needle,
      ~ safe_opls(select(., -group), .$group, predI = 2, permI = 500)) %>% 
  future_map("result") %>% 
  discard(is.null)
```



Save 'em!

```{r}
write_rds(needle.pls, here("data", "models", "needle-pls.rds"))
write_rds(needle.pls.force, here("data", "models", "needle-pls-force.rds"))
```

# Red Herring

## Red Herring PCAs

```{r message=FALSE, warning=FALSE}
herring.pcr.try <-
  future_map(herring,
      ~safe_pcr(.x, -group, group, CV = 7))

herring.pcr <-
  herring.pcr.try %>% 
  future_map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(herring.pcr.try) - length(herring.pcr)
#What was the error?
herring.pcr.try %>% 
  future_map("error") %>% 
  unique()
```

One where the PCA failed.

```{r}
write_rds(herring.pcr, here("data", "models", "herring-pcr.rds"))
```

## Red Herring PLS-DAs

```{r}
herring.pls.try <-
  future_map(herring,
      ~ safe_opls(select(., -group), .$group, permI = 500))

herring.pls <-
  herring.pls.try %>% 
  future_map("result") %>% 
  discard(is.null)
```

Any errors?

```{r}
length(herring.pls.try) - length(herring.pls)
# What's the error
herring.pls.try %>% 
  future_map("error") %>% 
  unique()
```

406/500 error because there are no significantly predictive components.  PLS is not fooled by the red herring!

Write em!

```{r}
write_rds(herring.pls, here("data", "models", "herring-pls.rds"))
```