---
title: "PCA regression and PLS-DA models summary statistics"
author: "Eric R. Scott"
output: html_notebook
---

```{r message=FALSE}
library(here)
library(tidyverse)
library(glue)
library(furrr)
library(rlang)
library(beepr)

source(here("R", "ropls_helpers.R"))
source(here("R", "RMSEP.R"))

set.seed(464)
```

Setup parallelization with furrr

```{r include=FALSE}
plan(multiprocess)
```

# Read in models
These were output by "4-analyze-simulated-data.Rmd"

```{r}
control.pls <- read_rds(here('data', 'models', 'control-pls.rds'))
control.pcr <- read_rds(here('data', 'models', 'control-pcr.rds'))
null.pls <- read_rds(here('data', 'models', 'null-pls.rds'))
null.pcr <- read_rds(here('data', 'models', 'null-pcr.rds'))
needle.pls <- read_rds(here('data', 'models', 'needle-pls.rds'))
needle.pcr <- read_rds(here('data', 'models', 'needle-pcr.rds'))
herring.pls <- read_rds(here('data', 'models', 'herring-pls.rds'))
herring.pcr <- read_rds(here('data', 'models', 'herring-pcr.rds'))
```


# Get Summary Stats

```{r message=FALSE, warning=FALSE}
null.pls.summary <- pls.summary(null.pls)
null.pcr.summary <- pcr.summary(null.pcr)
beep(4)
null.summary <-
  full_join(null.pls.summary, null.pcr.summary, by = "Statistic")

write_excel_csv(null.summary, here("out", "null summary.csv"))
```


```{r message=FALSE, warning=FALSE}
control.pls.summary <- pls.summary(control.pls)
control.pcr.summary <- pcr.summary(control.pcr)
beep(4)
control.summary <-
  full_join(control.pls.summary, control.pcr.summary, by = "Statistic")
write_excel_csv(control.summary, here("out", "control summary.csv"))
```


```{r message=FALSE, warning=FALSE}
needle.pls.summary <- pls.summary(needle.pls)
needle.pcr.summary <- pcr.summary(needle.pcr)
beep(4)
needle.summary <-
  full_join(needle.pls.summary, needle.pcr.summary, by = "Statistic")
write_excel_csv(needle.summary, here("out", "needle summary.csv"))
```


```{r}
herring.pls.summary <- pls.summary(herring.pls)
herring.pcr.summary <- pcr.summary(herring.pcr)
beep(4)
herring.summary <-
  full_join(herring.pls.summary, herring.pcr.summary, by = "Statistic")
write_excel_csv(herring.summary, here("out", "herring summary.csv"))
```


# Combine into one table

```{r}
stat_order <- c("n", "RMSEP", "R2X", "R2Y", "Q2", "%pR2 < 0.05", "%pQ2 < 0.05", "%p < 0.05")

outtable <- 
  list(null.summary, control.summary, needle.summary) %>% 
  map(~select(.x,Statistic, "PCA-LR" = ends_with("pcr"), "PLS-DA" = ends_with("pls"))) %>% 
  set_names(c("No predictors", "Apparent predictors", "Hidden predictors")) %>%
  bind_rows(.id = "Scenario") %>% 
  filter(Statistic %in% stat_order) %>% 
  mutate(Statistic = fct_relevel(Statistic, stat_order),
         Scenario = fct_inorder(Scenario)) %>% 
  arrange(Scenario, Statistic)

write_excel_csv(outtable, here("out", "model statistics table.csv"), na = "-")
```


