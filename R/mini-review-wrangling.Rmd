---
title: "Mini-review"
author: "Eric R. Scott"
date: "2019-10-28"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(googlesheets4)
library(googledrive)
library(rcrossref)
```

# Purpose

To pull my mini review table from google sheets, get full citations from DOIs in URLs, extract the year, and re-upload.

# Get sheet

```{r}
review_id <- drive_get(id = "1W5ChtX-bKpJJL8-znfeCWFeuenM7btjL9XUD2nxDxnE")
sheets_get(review_id)
sheets_sheets(review_id)
df <- read_sheet(review_id, "Mini-review")
df
```

# Get Citations from DOI

For any rows without citations, extract DOI, use it to get citation, add publication year.

```{r}
df2 <-
  df %>%
  mutate(doi = str_extract(url, "10\\..+"))

#check for duplicate rows
if(any(duplicated(df2$doi))) stop("Merge duplicates manually")


```

```{r}
safe_cr_cn <- possibly(cr_cn, NA)

df3 <- 
  df2 %>% 
  mutate(citation = ifelse(is.na(citation),
                           safe_cr_cn(doi, format = "text", style = "apa"),
                           citation)) %>%
  unnest(citation) %>% 
  mutate(year = ifelse(is.na(year),
                       str_extract(citation, "\\d{4}"),
                       year)) %>% 
  select(-doi)
head(df3)
```

## Write "raw" data locally and update google sheet.

```{r}
write_csv(df3, here("data", "mini-review.csv"))
```
```{r}
write_sheet(df3, "1W5ChtX-bKpJJL8-znfeCWFeuenM7btjL9XUD2nxDxnE", sheet = "out")
```


# Create supplementary and summary tables

## Read in completed version
Filter by year, write to .csv as a supplementary table

```{r}
df7 <-
  df3 %>% 
  filter(year == 2018) %>% 
  filter(!is.na(pls_use) | !is.na(pca_use)) %>% #remove studies that use neither PLS nor PCA
  select(-pca_use_old)
write_excel_csv(df7, here("out", "TableS1.csv"), na = " ")
```


## How many papers total and broken down by journal?

```{r}
nrow(df7)
count(df7, journal)
```

## how many papers use only PCA, only PLS, or both

```{r}
df7 %>% 
  summarize(just_PCA = sum(!is.na(pca_use) & is.na(pls_use)), 
            just_PLS = sum(!is.na(pls_use) & is.na(pca_use)),
            Both = sum(!is.na(pca_use) & !is.na(pls_use)))
```



## How is PLS used?

```{r}
pls_use <-
  df7 %>%
  filter(!is.na(pls_use)) %>% 
  mutate(pls_use = fct_infreq(pls_use)) %>% 
  count(pls_use) %>%
  rename("Use" = pls_use,
         "Number of publications" = n)
pls_use
```

## How is PCA used?

PCA use level 1

```{r}
pca_use <-
  df7 %>% 
  filter(!is.na(pca_use)) %>% 
  mutate(pca_use = fct_infreq(pca_use) %>% fct_relevel("PCs used as variables", after = Inf)) %>% 
  group_by(pca_use) %>% 
  count() %>% 
  rename("Use" = pca_use,
         "Number of publications" = n)
pca_use
```

If PCs are used as variables, how are they used?

```{r}
pc_variable_use <-
  df7 %>% 
  filter(!is.na(pc_variable_use)) %>% 
  mutate(pc_variable_use = fct_infreq(pc_variable_use) %>% 
           fct_relevel("Interest in relationships with raw variables",
                       after = Inf)) %>% 
  group_by(pc_variable_use) %>% 
  count() %>% 
  rename("Use" = pc_variable_use,
         "Number of publications" = n)

pc_variable_use
#check that all pc uses accounted for
sum(pc_variable_use[2]) == pca_use[4, 2]
```

If the authors are interested in doing a supervised type test, is there a more appropriate supervised drop-in replacement for what they did?

```{r}
supervised_alt <-
  df7 %>% 
  filter(!is.na(supervised_alt)) %>% 
  mutate(supervised_alt = fct_relevel(supervised_alt, "yes", "no", "maybe")) %>% 
  group_by(supervised_alt) %>% 
  count()  %>% 
  rename("Use" = supervised_alt,
         "Number of publications" = n)
supervised_alt
#checm that all accounted for
sum(supervised_alt[2]) == pc_variable_use[3, 2]
```


Combine, export, do some editing in Excel or Numbers for publication 

```{r}
bind_rows(pls_use, pca_use, pc_variable_use, supervised_alt) %>% write_csv(here("out", "review-table-rough.csv"))
```



## How often are other multivariate methods used?

```{r}
df7 %>% 
  filter(!is.na(other_supervised)) %>% count()
```
## How manuy uses of RDA, PERMANOVA, etc.

```{r}
df7 %>% 
  # filter(!is.na(pca_use_2) & (!is.na(pls_use) | !is.na(other_supervised))) %>%
  filter(!is.na(other_supervised)) %>% 
  separate_rows(other_supervised, sep = ", ") %>% 
  count(other_supervised) %>% 
  arrange(desc(n))
```

## How is PERMANOVA and PCA used together?

```{r}
df7 %>% 
  # filter(!is.na(pca_use_2) & (!is.na(pls_use) | !is.na(other_supervised))) %>%
  filter(!is.na(other_supervised)) %>% 
  separate_rows(other_supervised, sep = ", ") %>% 
  filter(other_supervised == "PERMANOVA") %>% 
  write_excel_csv(here("data", "subset.csv"))
```



