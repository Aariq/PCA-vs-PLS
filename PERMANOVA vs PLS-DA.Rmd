---
title: "PLS-DA vs PERMANOVA"
output: html_notebook
---

It seems like PERMANOVA is pretty good at doing discriminant analyses.  When is PLS-DA better, if ever?

#To-Do:
 - Try modifying function to allow for different variances between groups.  PERMANOVA is not robust to differences in variances between groups.  See how PLS-DA does.
 
*Looks like both methods are sensitive to departures from homogeniety of variances.*

# Setup
## Load packages
```{r message=FALSE, warning=FALSE}
# Required Packages
library(MASS)
library(tidyverse)
library(ropls)
library(chemhelper)
#chemhelper contains custom functions for interfacing with ropls package in a friendlier way (and other things).  
#Install with devtools::install_github("Aariq/chemhelper")
library(cowplot) #for making and saving prettier plots
library(broom) #for tidy(), which turns model output into dataframes
library(vegan) #for PERMANOVA
```

## Create Function to Generate Data
This code chunk creates the function `sim.vcov()` which generates a dataset where we can tune signal, noise, discriminating variables, strength of signal, and strength of discriminating variables. I'm using the notation `n` for number of observations and `p` for number of variables. `sim.vcov()` requires the following arguments:

- `p_noise`: how many variables with covariance = 0.01?
- `p_signal`: how many variables with some covariance (covariance = `cov_signal`)?
- `p_disc`: how many discriminating variables?
- `cov_signal`: the covariance for the variables with non-zero covariance.
- `diff_disc`: the difference in means for the discriminating variables between the two groups.
- `N`: how many observations?
- `seed`: passed to `set.seed()`

```{r}
# p_noise = 0
# p_signal = 5
# p_disc = 15
# cov_signal = 0.5
# diff_disc = 1
# cov_disc = 0.5
# group_vars = c(1,2)
# N = 20
# seed = NA

sim.vcov <- function(p_noise,
                     p_signal,
                     p_disc,
                     cov_signal,
                     cov_disc,
                     diff_disc,
                     group_vars = c(1, 1),
                     N,
                     seed = NA){
  # Choose a random number for seed if none is supplied
  if(is.na(seed)){
    seed = as.integer(runif(1) * 10e6)
  }
  # make noise data
  if(p_noise > 0){
  S_noise <- matrix(rep(0.01, p_noise^2), ncol = p_noise)
  diag(S_noise) <- 1
  set.seed(seed)
  data_noise <- mvrnorm(n = N, Sigma = S_noise, mu = rep(0, p_noise)) %>%
    as.data.frame()
  colnames(data_noise) <- paste0("noise_", 1:p_noise)
  } else {data_noise <- list()}
  
  # make signal data
  if(p_signal > 0){
    S_signal <- matrix(rep(cov_signal, p_signal^2), ncol = p_signal)
    # diag(S_signal) <- 1
    set.seed(seed)
    # data_signal <- mvrnorm(n = N, Sigma = S_signal, mu = rep(0, p_signal)) %>%
    #   as.data.frame()
    S_signal_B <- S_signal_A <- S_signal
   diag(S_signal_A) <- group_vars[1]
   signal_A <- mvrnorm(n = N/2, Sigma = S_signal_A, mu = rep(0, p_signal)) %>% 
     as.data.frame()
   
   diag(S_signal_B) <- group_vars[2]
   signal_B <- mvrnorm(n = N/2, Sigma = S_signal_B, mu = rep(0, p_signal)) %>% 
     as.data.frame()
   data_signal <- bind_rows(signal_A, signal_B)
   colnames(data_signal) <- paste0("signal_", 1:p_signal)
  } else {data_signal <- list()}
  
  # make discriminating data
  if(p_disc > 0){
  S_disc <- matrix(rep(cov_disc, p_disc^2), ncol = p_disc)
  
  # make data for group A
  diag(S_disc) <- group_vars[1]
  set.seed(seed)
  means_A <- rep((diff_disc/2), p_disc)
  data_A <- mvrnorm(n = N/2, mu = means_A, Sigma = S_disc) %>%
    as.data.frame()
  
  # make data for group B
  diag(S_disc) <- group_vars[2]
  set.seed(seed+1)
  means_B <- rep(-1*(diff_disc/2), p_disc)
  data_B <- mvrnorm(n = N/2, mu = means_B, Sigma = S_disc) %>%
    as.data.frame()
  
  data_disc <- bind_rows(data_A, data_B)
  colnames(data_disc) <- paste0("disc_", 1:p_disc)
  } else{data_disc <- list()}
  
  # column bind it all together
  sim.data <- bind_cols(data_disc, data_signal, data_noise) %>%
    add_column(group = rep(c("a","b"), each = N/2), .before = 1)
  
  return(sim.data)
}
```

# Permutation Testing
## Generate data
First, make a bunch of datasets with the same parameters
```{r}
nperm = 100 #how many perumutations

#generate data
sim.data.list <- map(1:nperm,
                      ~sim.vcov(p_noise = 0,
                                p_signal = 35,
                                p_disc = 25,
                                cov_signal = 0.5,
                                diff_disc = 1,
                                cov_disc = 0.5,
                                N = 10,
                                seed = NA))
```

# PERMANOVA
Do PERMANOVA on all of them
```{r}
PERMANOVAresults <- map_dbl(sim.data.list,
    ~ adonis(select(., -group) ~ .$group, method = "eu")$aov.tab$`Pr(>F)`[1])
```

# PLS-DA
Now do PLS-DA on all of them and get p-values (this will take a long time)
```{r include=FALSE}
plsda.list <- map(sim.data.list, ~opls(select(., -group), .$group, predI = 2, permI = 200, plotL = FALSE))
```

And extract p-values
```{r message=FALSE, warning=FALSE}
PLSresults <- plsda.list %>% map_df(~get_plotdata(.)$model_stats)
PLSresults
```

# Plot Results
```{r}
comparison <- bind_cols("permanova"= PERMANOVAresults, PLSresults)

p <- ggplot(comparison) +
  geom_density(aes(pQ2), fill = "red", alpha = 0.33) +
  geom_density(aes(permanova), fill = "green", alpha = 0.33) +
  labs(x = "p value") +
  geom_vline(xintercept = 0.05, linetype = 5) +
  ggtitle("Needle in a Haystack",subtitle="red = PLS-DA, green = PERMANOVA")
p
```