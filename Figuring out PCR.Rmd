---
title: "What's the deal with PCR?"
output: html_notebook
---

Goal:

- ~~figure out what pcr() function does~~
- ~~best way to select # of components to include in regression~~
- how to get RMSEP from pcr
- how best to map this to opls()-created pca models
- Do a regression on a factor or can you get RMSEP from a t-test?

```{r}
library(holodeck)
library(ropls)
library(tidyverse)
library(iheatmapr)
```

# Make a test dataset

I'm going to convert the group factor to numeric to simplify the process of figuring out how to do cross validation. Elizabeth and I confirmed that PLS-DA is just PLS with a dummy variable for the groups.

```{r}
set.seed(420)
df <- sim_cat(N = 30, n_groups = 2) %>% 
  sim_covar(p = 5, var = 1, cov = 0.5, name = "cov") %>% 
  sim_covar(p = 5, var = 1, cov = 0.5, name = "cov2") %>% 
  # sim_covar(p = 5, var = 1, cov = 0, name = "noise") %>% 
  group_by(group) %>% 
  sim_discr(p = 5, var = 1, cov = 0.1, group_means = c(-1, 1), name = "discr") %>% 
  ungroup() %>% 
  mutate(group = as.numeric(as.factor(group)))

X = df %>% select(-group)
Y = df$group
```

## Visualize covariance

```{r}
# df %>% 
#   select(-group) %>% 
#   cov() %>% 
#   iheatmap()
```


# Do PLSR

```{r}
plsda <- opls(select(df, -group), df$group, plotL = FALSE)
```


# Do PCA + Regression

```{r}
pca <- opls(select(df, -group), plotL = FALSE)
```




## Get scores

```{r}
scores <- get_scores(pca)
df.aug <-
  df %>% 
  add_column(p1 = scores$p1, p2 = scores$p2)

df.aug %>% select(group, p1, p2)
```

## Regression

```{r}
m <- glm(as.numeric(group) ~ p1 + p2, family = gaussian, data = df.aug)
summary(m)
car::Anova(m)
```


# Cross-validation

Goal: match CV that `opls()` does with PLS-DA models

0. Read worley and powers utilites paper
1. subset data
2. run PCA on analysis(data)
3. Use resulting loadings to predict PC scores on assessment(data)
4. do glm() on analysis(data)
5. use glm() to predict group membership for assessment(data)
6. calculate RMSEP

## 1. Create splits

Using `rsample` package

```{r}
library(rsample)
df.cv <- vfold_cv(df, 7)
```

## 2-5. CV function

First, a predict function to calculate scores from loadings and data

```{r}
# .newdata = sim_cat(N = 6, n_groups = 2) %>% 
#   sim_covar(p = 5, var = 1, cov = 0.5, name = "cov") %>% 
#   sim_covar(p = 5, var = 1, cov = 0.5, name = "cov2") %>% 
#   group_by(group) %>% 
#   sim_discr(p = 5, var = 1, cov = 0.1, group_means = c(-1, 1), name = "discr") %>% 
#   ungroup() %>% 
#   mutate(group = as.numeric(as.factor(group))) %>% 
#   select(-group) %>% 
#   mutate_all(~scale(.))
# 
# pca_mod = pca
```


```{r}
mypredict <- function(pca_mod, .newdata, .scale = TRUE) {
  #get loadings
  load <-
    get_loadings(pca_mod) %>%
    gather(-Variable, key = axis, value = loading) %>%
    spread(Variable, loading)
  
  #scale newdata
  if(scale){
    .newdata <- .newdata %>% mutate_all(~scale(.))
  }
  
  #check that columns are the same
  stopifnot(identical(colnames(.newdata), colnames(load %>% select(-axis))))
  
  #calc scores from loadings
  #clunky, but works
  pred.scores <-
    load %>% 
    group_by(axis) %>% 
    group_map(~{
      map2_dfc(.x = .newdata, .y = ., ~.x*.y) %>% rowSums(.) %>% as_tibble()
    }) %>% 
    mutate(sample = paste0("s", 1:nrow(.newdata))) %>% 
    spread(axis, value)
  
  return(pred.scores)
}
```

**Apply this to original data to check if it works!!!**

```{r}
mypredict(pca, df %>% select(-group)) %>% arrange((sample))
get_scores(pca) %>% arrange(sample)
```



This function should calculate RMSEP for a single split

```{r}
#model formula
mod_form <- as.formula(group ~ p1 + p2)

#test split
split <- df.cv$splits[[1]]

RMSEP <- function(split, ...) {
  #do pca on analysis(data)
  pca_mod <- opls(analysis(split) %>% select(-group), printL = FALSE, plotL = FALSE)
  
  #get_scores
  pca_scores <- cbind(get_scores(pca_mod), group = analysis(split)$group)
  
  #predict pc axis scores on assessment data
  scores.pred <- mypredict(pca_mod, assessment(split) %>% select(-group))
  
  #do glm on analysis data
  m <- glm(mod_form, family = gaussian, data = pca_scores)

  #use glm to predict `group` for newdata
  scores.pred %>% 
    mutate(group.pred = predict(m, newdata = scores.pred)) %>% 
    add_column(group.actual = assessment(split)$group) %>% 
    mutate(sq_err = (group.actual - group.pred)^2) %>% 
    summarize(RMSEP = sqrt(mean(sq_err))) %>% 
    as.numeric()

}

```

$$
RMSEE = \sqrt{\frac{1}{n}\times \sum(A_i-P_i)^2}
$$

```{r}
example <- RMSEP(df.cv$splits[[1]], X_vars = -group, Y_vars = group)
analysis(df.cv$splits[[1]])
```

#6. apply that function to all the splits and get mean RMSEP

```{r}
df.cv %>%
  mutate(RMSEP = map_dbl(splits, RMSEP)) %>% 
  summarize(RMSEP = mean(RMSEP))
```


